<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IO Arena - Real Multiplayer Battle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            color: white;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        #gameCanvas {
            display: block;
            background: transparent;
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #topBar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .stat-icon {
            font-size: 20px;
        }

        #leaderboard {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 200px;
            pointer-events: auto;
        }

        #leaderboard h3 {
            margin-bottom: 15px;
            text-align: center;
            color: #ffd700;
            font-size: 18px;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .leaderboard-entry:last-child {
            border-bottom: none;
        }

        .rank {
            font-weight: bold;
            color: #ffd700;
            min-width: 30px;
        }

        .player-name {
            flex: 1;
            margin: 0 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .score {
            font-weight: bold;
            color: #00ff88;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            font-size: 14px;
            color: #ccc;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: none;
            pointer-events: auto;
        }

        #gameOver h2 {
            color: #ff6b6b;
            margin-bottom: 20px;
            font-size: 32px;
        }

        #gameOver p {
            margin-bottom: 30px;
            font-size: 18px;
            color: #ccc;
        }

        #restartBtn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #restartBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        #powerUps {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: auto;
        }

        .powerUp {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .powerUp:last-child {
            margin-bottom: 0;
        }

        .powerUp-icon {
            font-size: 20px;
        }

        .powerUp-timer {
            color: #ffd700;
            font-weight: bold;
        }

        #minimap {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        #minimapCanvas {
            width: 100%;
            height: 100%;
        }

        #connectionStatus {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            pointer-events: auto;
        }

        .status-connected {
            color: #00ff88;
        }

        .status-connecting {
            color: #ffaa00;
        }

        .status-disconnected {
            color: #ff4444;
        }

        #playerCount {
            position: absolute;
            top: 20px;
            left: 200px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            pointer-events: auto;
        }

        #loginScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-form {
            background: rgba(0, 0, 0, 0.8);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            min-width: 300px;
        }

        .login-form h2 {
            margin-bottom: 30px;
            color: #ffd700;
            font-size: 28px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            outline: none;
        }

        .input-group input:focus {
            background: rgba(255, 255, 255, 0.2);
        }

        #joinBtn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        #joinBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(78, 205, 196, 0.3);
        }

        #joinBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            animation: fadeOut 1s ease-out forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: scale(0);
            }
        }

        .glow {
            filter: drop-shadow(0 0 10px currentColor);
        }

        /* Team mode styles */
        .team-red {
            color: #ff4444 !important;
        }

        .team-blue {
            color: #448aff !important;
        }

        .team-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
        }

        .duel-waiting {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
        }

        .duel-waiting h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }

        .duel-waiting .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: white;
            text-align: center;
        }

        /* Main Menu Overlay */
        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #mainMenu .container {
            background: rgba(0, 0, 0, 0.85);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 40px 60px;
            display: flex;
            flex-direction: row;
            gap: 40px;
            align-items: stretch;
            min-width: 600px;
            max-width: 90vw;
        }

        #mainMenu .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            justify-content: flex-start;
            min-width: 180px;
        }

        #mainMenu .sidebar .mode-btn {
            padding: 12px 0;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #222;
            color: white;
            cursor: pointer;
        }

        #mainMenu .sidebar .mode-btn.selected {
            background: linear-gradient(45deg, #4ecdc4, #44a08d) !important;
            color: #fff !important;
            font-weight: bold;
            box-shadow: 0 2px 8px #0002;
        }

        #mainMenu .content {
            display: flex;
            flex-direction: column;
            gap: 24px;
            align-items: center;
            min-width: 320px;
        }

        #mainMenu .content h1 {
            font-size: 36px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 2px 8px #000;
        }

        #mainMenu .content a {
            color: #ffd700;
            font-size: 15px;
            text-decoration: underline;
            margin-bottom: 10px;
        }

        #mainMenu .content .input-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        #mainMenu .content .input-group label {
            color: #ccc;
            font-size: 15px;
        }

        #mainMenu .content .input-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: #222;
            color: white;
            font-size: 16px;
        }

        #mainMenu .content button {
            margin-top: 20px;
            padding: 14px 40px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            cursor: pointer;
            box-shadow: 0 2px 8px #000;
        }

        /* Add styles for selected mode button */
        .mode-btn.selected {
            background: linear-gradient(45deg, #4ecdc4, #44a08d) !important;
            color: #fff !important;
            font-weight: bold;
            box-shadow: 0 2px 8px #0002;
        }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-form">
            <h2>üéÆ IO Arena</h2>
            <div class="input-group">
                <label for="playerName">Player Name:</label>
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
            </div>
            <div class="input-group">
                <label for="serverUrl">Server URL:</label>
                <input type="text" id="serverUrl" placeholder="ws://localhost:8080" value="ws://localhost:8080">
            </div>
            <button id="joinBtn">Join Game</button>
        </div>
    </div>

    <div id="loadingScreen" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Connecting to server...</div>
    </div>

    <div id="gameContainer" style="display: none;">
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui">
            <div id="connectionStatus" class="status-disconnected">
                üî¥ Disconnected
            </div>
            <div id="playerCount">
                üë• Players: 0
            </div>

            <div id="topBar">
                <div class="stat">
                    <span class="stat-icon">‚≠ê</span>
                    <span id="score">0</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">üéØ</span>
                    <span id="kills">0</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">üíé</span>
                    <span id="size">20</span>
                </div>
            </div>

            <div id="leaderboard">
                <h3>üèÜ Leaderboard</h3>
                <div id="leaderboardList"></div>
            </div>

            <div id="powerUps">
                <h4>‚ö° Power-ups</h4>
                <div id="powerUpList"></div>
            </div>

            <div id="minimap">
                <canvas id="minimapCanvas"></canvas>
            </div>

            <div id="controls">
                <strong>WASD</strong> to move ‚Ä¢ <strong>Mouse</strong> to aim ‚Ä¢ <strong>Click</strong> to shoot
            </div>
        </div>

        <div id="gameOver">
            <h2>üíÄ Game Over!</h2>
            <p>Final Score: <span id="finalScore">0</span></p>
            <p>Kills: <span id="finalKills">0</span></p>
            <button id="restartBtn">Play Again</button>
        </div>

        <!-- Duel Waiting Overlay -->
        <div id="duelWaiting" style="display: none;">
            <div class="duel-waiting">
                <div class="spinner"></div>
                <h3>‚öîÔ∏è Waiting for Opponent</h3>
                <p>Finding a duel partner...</p>
            </div>
        </div>
    </div>

    <!-- Main Menu Overlay -->
    <div id="mainMenu" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
        <div style="background:rgba(0,0,0,0.85);border-radius:24px;box-shadow:0 8px 32px rgba(0,0,0,0.3);padding:40px 60px;display:flex;flex-direction:row;gap:40px;align-items:stretch;min-width:600px;max-width:90vw;">
            <!-- Sidebar for modes -->
            <div style="display:flex;flex-direction:column;gap:20px;justify-content:flex-start;min-width:180px;">
                <div style="font-size:22px;font-weight:bold;color:#ffd700;margin-bottom:10px;">Modes</div>
                <button class="mode-btn selected" data-mode="ffa" style="padding:12px 0;font-size:16px;border:none;border-radius:8px;background:#222;color:white;cursor:pointer;">Free For All</button>
                <button class="mode-btn" data-mode="teams" style="padding:12px 0;font-size:16px;border:none;border-radius:8px;background:#222;color:white;cursor:pointer;">Teams</button>
                <button class="mode-btn" data-mode="duel" style="padding:12px 0;font-size:16px;border:none;border-radius:8px;background:#222;color:white;cursor:pointer;">Duel</button>
            </div>
            <!-- Main content -->
            <div style="display:flex;flex-direction:column;gap:24px;align-items:center;min-width:320px;">
                <div style="font-size:36px;font-weight:bold;color:#fff;text-shadow:0 2px 8px #000;">IO Arena</div>
                <a href="/" style="color:#ffd700;font-size:15px;text-decoration:underline;margin-bottom:10px;">‚Üê Back to My Website</a>
                <div style="width:100%;display:flex;flex-direction:column;gap:16px;">
                    <label style="color:#ccc;font-size:15px;">Player Name
                        <input id="menuPlayerName" type="text" maxlength="20" style="width:100%;padding:10px;border-radius:8px;border:none;background:#222;color:white;font-size:16px;margin-top:4px;">
                    </label>
                    <label style="color:#ccc;font-size:15px;">Player Color
                        <input id="menuPlayerColor" type="color" value="#4ecdc4" style="width:48px;height:32px;border:none;margin-left:10px;vertical-align:middle;">
                    </label>
                </div>
                <button id="menuPlayBtn" style="margin-top:20px;padding:14px 40px;font-size:18px;font-weight:bold;border:none;border-radius:12px;background:linear-gradient(45deg,#4ecdc4,#44a08d);color:white;cursor:pointer;box-shadow:0 2px 8px #000;">Play</button>
            </div>
        </div>
    </div>

    <script>
        class MultiplayerIOGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.minimapCanvas = document.getElementById('minimapCanvas');
                this.minimapCtx = this.minimapCanvas.getContext('2d');
                
                this.setupCanvas();
                this.setupEventListeners();
                this.setupMainMenu();
                
                // Game mode state
                this.currentMode = 'ffa';
                this.team = null;
                this.room = null;
                this.duelResult = null;
            }

            setupCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.minimapCanvas.width = 150;
                this.minimapCanvas.height = 150;
                
                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                });
            }

            setupMainMenu() {
                // Show main menu initially instead of login screen
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainMenu').style.display = 'flex';
                document.getElementById('gameContainer').style.display = 'none';
            }

            startWithMenuSelection() {
                const selection = window.IO_MENU_SELECTION;
                if (!selection) {
                    console.error('No menu selection found');
                    return;
                }

                this.playerName = selection.name;
                this.playerColor = selection.color;
                this.currentMode = selection.mode;
                this.serverUrl = 'ws://localhost:8080';

                // Show loading screen
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('loadingScreen').style.display = 'flex';
                document.getElementById('gameContainer').style.display = 'block';

                // Update connection status
                this.updateConnectionStatus('connecting', 'üü° Connecting...');

                // Create WebSocket connection
                this.ws = new WebSocket(this.serverUrl);

                this.ws.onopen = () => {
                    console.log('Connected to server');
                    this.updateConnectionStatus('connected', 'üü¢ Connected');
                    this.setupGame();
                    this.startGame();
                    
                    // Send player join message with mode and color
                    this.sendMessage({
                        type: 'join',
                        playerName: this.playerName,
                        playerColor: this.playerColor,
                        mode: this.currentMode
                    });

                    // Show duel waiting overlay if in duel mode
                    if (this.currentMode === 'duel') {
                        this.showDuelWaiting();
                    }
                };

                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleServerMessage(message);
                    } catch (error) {
                        console.error('Error parsing server message:', error);
                    }
                };

                this.ws.onclose = () => {
                    console.log('Disconnected from server');
                    this.updateConnectionStatus('disconnected', 'üî¥ Disconnected');
                    this.gameState = 'disconnected';
                    this.hideDuelWaiting();
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateConnectionStatus('disconnected', 'üî¥ Connection Failed');
                    alert('Failed to connect to server. Please check the URL and try again.');
                    this.showMainMenu();
                    this.hideDuelWaiting();
                };
            }

            setupLogin() {
                // This method is now deprecated in favor of main menu
                // Keep for backward compatibility
                const joinBtn = document.getElementById('joinBtn');
                const playerNameInput = document.getElementById('playerName');
                const serverUrlInput = document.getElementById('serverUrl');

                // Auto-generate player name
                playerNameInput.value = 'Player' + Math.floor(Math.random() * 1000);

                joinBtn.addEventListener('click', () => {
                    const playerName = playerNameInput.value.trim();
                    const serverUrl = serverUrlInput.value.trim();

                    if (!playerName) {
                        alert('Please enter a player name!');
                        return;
                    }

                    if (!serverUrl) {
                        alert('Please enter a server URL!');
                        return;
                    }

                    this.connectToServer(serverUrl, playerName);
                });

                // Allow Enter key to join
                playerNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') joinBtn.click();
                });
                serverUrlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') joinBtn.click();
                });
            }

            connectToServer(serverUrl, playerName) {
                // Legacy method - use startWithMenuSelection instead
                this.playerName = playerName;
                this.serverUrl = serverUrl;

                // Show loading screen
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('loadingScreen').style.display = 'flex';
                document.getElementById('gameContainer').style.display = 'block';

                // Update connection status
                this.updateConnectionStatus('connecting', 'üü° Connecting...');

                // Create WebSocket connection
                this.ws = new WebSocket(serverUrl);

                this.ws.onopen = () => {
                    console.log('Connected to server');
                    this.updateConnectionStatus('connected', 'üü¢ Connected');
                    this.setupGame();
                    this.startGame();
                    
                    // Send player join message
                    this.sendMessage({
                        type: 'join',
                        playerName: this.playerName,
                        mode: 'ffa' // Default to FFA for legacy
                    });
                };

                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleServerMessage(message);
                    } catch (error) {
                        console.error('Error parsing server message:', error);
                    }
                };

                this.ws.onclose = () => {
                    console.log('Disconnected from server');
                    this.updateConnectionStatus('disconnected', 'üî¥ Disconnected');
                    this.gameState = 'disconnected';
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateConnectionStatus('disconnected', 'üî¥ Connection Failed');
                    alert('Failed to connect to server. Please check the URL and try again.');
                    this.showLoginScreen();
                };
            }

            updateConnectionStatus(status, text) {
                const statusEl = document.getElementById('connectionStatus');
                statusEl.className = `status-${status}`;
                statusEl.textContent = text;
            }

            showLoginScreen() {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
            }

            showMainMenu() {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('mainMenu').style.display = 'flex';
            }

            sendMessage(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                }
            }

            handleServerMessage(message) {
                switch (message.type) {
                    case 'gameState':
                        this.updateGameState(message.data);
                        break;
                    case 'playerJoined':
                        this.addPlayer(message.player);
                        // Update local player info if it's us
                        if (message.player.name === this.playerName) {
                            this.currentMode = message.player.mode;
                            this.team = message.player.team;
                            this.room = message.player.room;
                            this.updateModeUI();
                            
                            // Hide duel waiting overlay if we're in a duel room
                            if (this.currentMode === 'duel' && this.room) {
                                this.hideDuelWaiting();
                            }
                        }
                        break;
                    case 'playerLeft':
                        this.removePlayer(message.playerId);
                        break;
                    case 'playerUpdate':
                        this.updatePlayer(message.player);
                        break;
                    case 'bulletCreated':
                        this.addBullet(message.bullet);
                        break;
                    case 'bulletRemoved':
                        this.removeBullet(message.bulletId);
                        break;
                    case 'foodCreated':
                        this.addFood(message.food);
                        break;
                    case 'foodRemoved':
                        this.removeFood(message.foodId);
                        break;
                    case 'powerUpCreated':
                        this.addPowerUp(message.powerUp);
                        break;
                    case 'powerUpRemoved':
                        this.removePowerUp(message.powerUpId);
                        break;
                    case 'playerKilled':
                        this.handlePlayerKilled(message);
                        break;
                    case 'playerStats':
                        this.updatePlayerStats(message.stats);
                        break;
                    case 'playerCount':
                        this.updatePlayerCount(message.count);
                        break;
                    case 'duelResult':
                        this.handleDuelResult(message);
                        break;
                }
            }

            handleDuelResult(message) {
                this.duelResult = message;
                this.gameState = 'duelEnd';
                this.showDuelResult();
            }

            showDuelResult() {
                const result = this.duelResult;
                const gameOver = document.getElementById('gameOver');
                const finalScore = document.getElementById('finalScore');
                const finalKills = document.getElementById('finalKills');
                const restartBtn = document.getElementById('restartBtn');

                if (result.winner) {
                    gameOver.querySelector('h2').textContent = 'üèÜ Victory!';
                    gameOver.querySelector('h2').style.color = '#00ff88';
                } else {
                    gameOver.querySelector('h2').textContent = 'üíÄ Defeat';
                    gameOver.querySelector('h2').style.color = '#ff6b6b';
                }

                finalScore.textContent = result.yourScore;
                finalKills.textContent = Math.floor(result.survivedMs / 1000) + 's';
                
                restartBtn.textContent = 'Back to Menu';
                restartBtn.onclick = () => {
                    gameOver.style.display = 'none';
                    this.showMainMenu();
                };

                gameOver.style.display = 'block';
            }

            updateModeUI() {
                // Update UI based on current mode
                const topBar = document.getElementById('topBar');
                const leaderboard = document.getElementById('leaderboard');
                
                if (this.currentMode === 'teams') {
                    // Add team indicator
                    if (!document.getElementById('teamIndicator')) {
                        const teamIndicator = document.createElement('div');
                        teamIndicator.id = 'teamIndicator';
                        teamIndicator.className = 'stat';
                        teamIndicator.innerHTML = `
                            <span class="stat-icon">${this.team === 'red' ? 'üî¥' : 'üîµ'}</span>
                            <span>${this.team === 'red' ? 'Red' : 'Blue'} Team</span>
                        `;
                        topBar.appendChild(teamIndicator);
                    }
                    
                    // Update leaderboard title
                    leaderboard.querySelector('h3').textContent = 'üèÜ Team Leaderboard';
                } else if (this.currentMode === 'duel') {
                    // Update leaderboard title
                    leaderboard.querySelector('h3').textContent = '‚öîÔ∏è Duel';
                    
                    // Remove team indicator if exists
                    const teamIndicator = document.getElementById('teamIndicator');
                    if (teamIndicator) teamIndicator.remove();
                } else {
                    // FFA mode
                    leaderboard.querySelector('h3').textContent = 'üèÜ Leaderboard';
                    
                    // Remove team indicator if exists
                    const teamIndicator = document.getElementById('teamIndicator');
                    if (teamIndicator) teamIndicator.remove();
                }
            }

            setupGame() {
                // Game state
                this.gameState = 'playing';
                this.score = 0;
                this.kills = 0;
                this.size = 20;
                
                // Player
                this.player = {
                    id: null,
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2,
                    vx: 0,
                    vy: 0,
                    size: 20,
                    color: this.playerColor || this.getRandomColor(),
                    name: this.playerName,
                    health: 100,
                    maxHealth: 100,
                    powerUps: new Map(),
                    lastShot: 0,
                    shotCooldown: 200
                };

                // Game world
                this.worldSize = 5000;
                this.camera = {
                    x: this.player.x - window.innerWidth / 2,
                    y: this.player.y - window.innerHeight / 2
                };

                // Entities
                this.players = new Map();
                this.bullets = new Map();
                this.powerUps = new Map();
                this.particles = [];
                this.food = new Map();

                // Mouse
                this.mouse = { x: 0, y: 0 };

                // Animation
                this.lastTime = 0;
                this.deltaTime = 0;

                // Input state
                this.keys = {
                    w: false, s: false, a: false, d: false
                };
            }

            setupEventListeners() {
                // Keyboard
                document.addEventListener('keydown', (e) => {
                    if (this.gameState !== 'playing') return;
                    
                    switch(e.code) {
                        case 'KeyW': this.keys.w = true; break;
                        case 'KeyS': this.keys.s = true; break;
                        case 'KeyA': this.keys.a = true; break;
                        case 'KeyD': this.keys.d = true; break;
                    }
                });

                document.addEventListener('keyup', (e) => {
                    switch(e.code) {
                        case 'KeyW': this.keys.w = false; break;
                        case 'KeyS': this.keys.s = false; break;
                        case 'KeyA': this.keys.a = false; break;
                        case 'KeyD': this.keys.d = false; break;
                    }
                });

                // Mouse
                this.canvas.addEventListener('mousemove', (e) => {
                    this.mouse.x = e.clientX;
                    this.mouse.y = e.clientY;
                });

                this.canvas.addEventListener('click', (e) => {
                    if (this.gameState !== 'playing') return;
                    this.shoot();
                });

                // Restart button
                document.getElementById('restartBtn').addEventListener('click', () => {
                    this.restart();
                });
            }

            updateGameState(gameState) {
                // Update all game entities from server state
                this.players.clear();
                this.bullets.clear();
                this.food.clear();
                this.powerUps.clear();

                // Add players
                for (const player of gameState.players) {
                    this.players.set(player.id, player);
                    if (player.name === this.playerName) {
                        this.player = player;
                    }
                }

                // Add bullets
                for (const bullet of gameState.bullets) {
                    this.bullets.set(bullet.id, bullet);
                }

                // Add food
                for (const food of gameState.food) {
                    this.food.set(food.id, food);
                }

                // Add power-ups
                for (const powerUp of gameState.powerUps) {
                    this.powerUps.set(powerUp.id, powerUp);
                }
            }

            addPlayer(player) {
                this.players.set(player.id, player);
            }

            removePlayer(playerId) {
                this.players.delete(playerId);
            }

            updatePlayer(player) {
                this.players.set(player.id, player);
                if (player.name === this.playerName) {
                    this.player = player;
                }
            }

            addBullet(bullet) {
                this.bullets.set(bullet.id, bullet);
            }

            removeBullet(bulletId) {
                this.bullets.delete(bulletId);
            }

            addFood(food) {
                this.food.set(food.id, food);
            }

            removeFood(foodId) {
                this.food.delete(foodId);
            }

            addPowerUp(powerUp) {
                this.powerUps.set(powerUp.id, powerUp);
            }

            removePowerUp(powerUpId) {
                this.powerUps.delete(powerUpId);
            }

            handlePlayerKilled(message) {
                if (message.killerName === this.playerName) {
                    this.kills++;
                    this.score += 100;
                }
                
                if (message.victimName === this.playerName) {
                    this.gameOver();
                }
            }

            updatePlayerStats(stats) {
                this.score = stats.score;
                this.kills = stats.kills;
            }

            updatePlayerCount(count) {
                document.getElementById('playerCount').textContent = `üë• Players: ${count}`;
            }

            shoot() {
                const now = Date.now();
                if (now - this.player.lastShot < this.player.shotCooldown) return;

                const angle = Math.atan2(
                    this.mouse.y + this.camera.y - this.player.y,
                    this.mouse.x + this.camera.x - this.player.x
                );

                // Send shoot message to server
                this.sendMessage({
                    type: 'shoot',
                    angle: angle
                });

                this.player.lastShot = now;
            }

            update(deltaTime) {
                if (this.gameState !== 'playing') return;

                this.updatePlayerInput();
                this.updateParticles(deltaTime);
                this.updateCamera();
                this.updateUI();
                this.updateMinimap();
            }

            updatePlayerInput() {
                // Calculate movement direction
                let vx = 0, vy = 0;
                if (this.keys.w) vy -= 5;
                if (this.keys.s) vy += 5;
                if (this.keys.a) vx -= 5;
                if (this.keys.d) vx += 5;

                // Send movement to server
                if (vx !== 0 || vy !== 0) {
                    this.sendMessage({
                        type: 'move',
                        vx: vx,
                        vy: vy
                    });
                }
            }

            updateParticles(deltaTime) {
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.life--;
                    
                    if (particle.life <= 0) {
                        this.particles.splice(i, 1);
                    }
                }
            }

            updateCamera() {
                if (this.player) {
                    this.camera.x = this.player.x - window.innerWidth / 2;
                    this.camera.y = this.player.y - window.innerHeight / 2;
                }
            }

            updateUI() {
                if (this.player) {
                    document.getElementById('score').textContent = this.score;
                    document.getElementById('kills').textContent = this.kills;
                    document.getElementById('size').textContent = Math.floor(this.player.size);
                }

                // Update leaderboard
                let sortedPlayers = Array.from(this.players.values());
                
                // Filter players based on mode
                if (this.currentMode === 'teams') {
                    sortedPlayers = sortedPlayers.filter(p => p.team === this.team);
                } else if (this.currentMode === 'duel') {
                    sortedPlayers = sortedPlayers.filter(p => p.room === this.room);
                }
                
                sortedPlayers = sortedPlayers
                    .sort((a, b) => (b.size * 10 + (b.health / b.maxHealth) * 100) - (a.size * 10 + (a.health / a.maxHealth) * 100))
                    .slice(0, 10);

                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '';

                sortedPlayers.forEach((player, index) => {
                    const entry = document.createElement('div');
                    entry.className = 'leaderboard-entry';
                    
                    let playerName = player.name;
                    let playerColor = player.color;
                    
                    // Add team indicator for team mode
                    if (this.currentMode === 'teams' && player.team) {
                        const teamIcon = player.team === 'red' ? 'üî¥' : 'üîµ';
                        playerName = `${teamIcon} ${player.name}`;
                    }
                    
                    // Add room indicator for duel mode
                    if (this.currentMode === 'duel') {
                        playerName = `‚öîÔ∏è ${player.name}`;
                    }
                    
                    entry.innerHTML = `
                        <span class="rank">${index + 1}</span>
                        <span class="player-name" style="color: ${playerColor}">${playerName}</span>
                        <span class="score">${Math.floor(player.size)}</span>
                    `;
                    leaderboardList.appendChild(entry);
                });

                // Update power-ups
                const powerUpList = document.getElementById('powerUpList');
                powerUpList.innerHTML = '';

                if (this.player && this.player.powerUps) {
                    for (const [type, powerUp] of this.player.powerUps) {
                        const powerUpEl = document.createElement('div');
                        powerUpEl.className = 'powerUp';
                        powerUpEl.innerHTML = `
                            <span class="powerUp-icon">${this.getPowerUpIcon(type)}</span>
                            <span>${type}</span>
                            <span class="powerUp-timer">${Math.ceil(powerUp.duration / 1000)}s</span>
                        `;
                        powerUpList.appendChild(powerUpEl);
                    }
                }
            }

            updateMinimap() {
                this.minimapCtx.clearRect(0, 0, 150, 150);
                
                // Draw background
                this.minimapCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                this.minimapCtx.fillRect(0, 0, 150, 150);

                const scale = 150 / this.worldSize;

                // Draw food
                this.minimapCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                for (const food of this.food.values()) {
                    this.minimapCtx.beginPath();
                    this.minimapCtx.arc(
                        food.x * scale,
                        food.y * scale,
                        1,
                        0,
                        Math.PI * 2
                    );
                    this.minimapCtx.fill();
                }

                // Draw power-ups
                this.minimapCtx.fillStyle = 'rgba(255, 215, 0, 0.8)';
                for (const powerUp of this.powerUps.values()) {
                    this.minimapCtx.beginPath();
                    this.minimapCtx.arc(
                        powerUp.x * scale,
                        powerUp.y * scale,
                        2,
                        0,
                        Math.PI * 2
                    );
                    this.minimapCtx.fill();
                }

                // Draw players
                for (const player of this.players.values()) {
                    this.minimapCtx.fillStyle = player.color;
                    this.minimapCtx.beginPath();
                    this.minimapCtx.arc(
                        player.x * scale,
                        player.y * scale,
                        Math.max(1, player.size * scale * 0.1),
                        0,
                        Math.PI * 2
                    );
                    this.minimapCtx.fill();

                    // Highlight current player
                    if (player.name === this.playerName) {
                        this.minimapCtx.strokeStyle = 'white';
                        this.minimapCtx.lineWidth = 2;
                        this.minimapCtx.stroke();
                    }
                }
            }

            createParticles(x, y, color, count) {
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: x + (Math.random() - 0.5) * 20,
                        y: y + (Math.random() - 0.5) * 20,
                        vx: (Math.random() - 0.5) * 10,
                        vy: (Math.random() - 0.5) * 10,
                        color: color,
                        life: 30 + Math.random() * 20,
                        size: 2 + Math.random() * 3
                    });
                }
            }

            render() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw background grid
                this.drawGrid();

                // Draw food
                for (const food of this.food.values()) {
                    this.drawCircle(food.x - this.camera.x, food.y - this.camera.y, food.size, food.color);
                }

                // Draw power-ups
                for (const powerUp of this.powerUps.values()) {
                    this.drawPowerUp(powerUp.x - this.camera.x, powerUp.y - this.camera.y, powerUp);
                }

                // Draw bullets
                for (const bullet of this.bullets.values()) {
                    this.drawCircle(bullet.x - this.camera.x, bullet.y - this.camera.y, bullet.size, bullet.color);
                }

                // Draw particles
                for (const particle of this.particles) {
                    this.drawCircle(particle.x - this.camera.x, particle.y - this.camera.y, particle.size, particle.color);
                }

                // Draw players
                for (const player of this.players.values()) {
                    this.drawPlayer(player.x - this.camera.x, player.y - this.camera.y, player);
                }
            }

            drawGrid() {
                const gridSize = 100;
                const offsetX = this.camera.x % gridSize;
                const offsetY = this.camera.y % gridSize;

                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.lineWidth = 1;

                for (let x = -offsetX; x < this.canvas.width + gridSize; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }

                for (let y = -offsetY; y < this.canvas.height + gridSize; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
            }

            drawCircle(x, y, radius, color) {
                this.ctx.fillStyle = color;
                this.ctx.beginPath();
                this.ctx.arc(x, y, radius, 0, Math.PI * 2);
                this.ctx.fill();
            }

            drawPlayer(x, y, player) {
                // Draw player body
                this.ctx.fillStyle = player.color;
                this.ctx.beginPath();
                this.ctx.arc(x, y, player.size, 0, Math.PI * 2);
                this.ctx.fill();

                // Draw health bar
                const healthBarWidth = player.size * 2;
                const healthBarHeight = 4;
                const healthPercentage = player.health / player.maxHealth;

                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                this.ctx.fillRect(x - healthBarWidth / 2, y - player.size - 10, healthBarWidth, healthBarHeight);

                this.ctx.fillStyle = healthPercentage > 0.5 ? '#00ff88' : healthPercentage > 0.25 ? '#ffaa00' : '#ff4444';
                this.ctx.fillRect(x - healthBarWidth / 2, y - player.size - 10, healthBarWidth * healthPercentage, healthBarHeight);

                // Draw player name
                this.ctx.fillStyle = 'white';
                this.ctx.font = '12px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(player.name, x, y - player.size - 15);

                // Draw shield effect
                if (player.powerUps && player.powerUps.has('Shield')) {
                    this.ctx.strokeStyle = '#00bfff';
                    this.ctx.lineWidth = 3;
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, player.size + 5, 0, Math.PI * 2);
                    this.ctx.stroke();
                }
            }

            drawPowerUp(x, y, powerUp) {
                // Draw power-up background
                this.ctx.fillStyle = powerUp.color;
                this.ctx.beginPath();
                this.ctx.arc(x, y, 15, 0, Math.PI * 2);
                this.ctx.fill();

                // Draw power-up icon
                this.ctx.fillStyle = 'white';
                this.ctx.font = '20px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(powerUp.icon, x, y + 6);

                // Draw pulsing effect
                const pulse = Math.sin(Date.now() * 0.01) * 0.2 + 1;
                this.ctx.strokeStyle = powerUp.color;
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.arc(x, y, 15 * pulse, 0, Math.PI * 2);
                this.ctx.stroke();
            }

            getRandomColor() {
                const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            getPowerUpIcon(type) {
                const icons = {
                    'Speed Boost': '‚ö°',
                    'Size Increase': 'üìà',
                    'Rapid Fire': 'üî•',
                    'Shield': 'üõ°Ô∏è'
                };
                return icons[type] || '‚ö°';
            }

            gameOver() {
                this.gameState = 'gameOver';
                
                const gameOver = document.getElementById('gameOver');
                const finalScore = document.getElementById('finalScore');
                const finalKills = document.getElementById('finalKills');
                const restartBtn = document.getElementById('restartBtn');
                
                // Update title based on mode
                if (this.currentMode === 'teams') {
                    gameOver.querySelector('h2').textContent = 'üíÄ Team Death!';
                    restartBtn.textContent = 'Respawn';
                } else if (this.currentMode === 'duel') {
                    gameOver.querySelector('h2').textContent = 'üíÄ Duel Lost!';
                    restartBtn.textContent = 'Back to Menu';
                } else {
                    gameOver.querySelector('h2').textContent = 'üíÄ Game Over!';
                    restartBtn.textContent = 'Play Again';
                }
                
                finalScore.textContent = this.score;
                finalKills.textContent = this.kills;
                gameOver.style.display = 'block';
            }

            restart() {
                document.getElementById('gameOver').style.display = 'none';
                
                if (this.currentMode === 'duel') {
                    // For duel mode, go back to main menu
                    this.showMainMenu();
                } else {
                    // For FFA and Teams, respawn in the same game
                    this.sendMessage({ type: 'respawn' });
                    this.gameState = 'playing';
                }
            }

            startGame() {
                document.getElementById('loadingScreen').style.display = 'none';
                
                const gameLoop = (currentTime) => {
                    this.deltaTime = currentTime - this.lastTime;
                    this.lastTime = currentTime;

                    this.update(this.deltaTime);
                    this.render();

                    requestAnimationFrame(gameLoop);
                };

                requestAnimationFrame(gameLoop);
            }

            showDuelWaiting() {
                document.getElementById('duelWaiting').style.display = 'block';
            }

            hideDuelWaiting() {
                document.getElementById('duelWaiting').style.display = 'none';
            }
        }

        // Main Menu Logic
        (function() {
            const mainMenu = document.getElementById('mainMenu');
            const playBtn = document.getElementById('menuPlayBtn');
            const nameInput = document.getElementById('menuPlayerName');
            const colorInput = document.getElementById('menuPlayerColor');
            const modeBtns = Array.from(document.querySelectorAll('.mode-btn'));
            let selectedMode = 'ffa';

            // Default name
            nameInput.value = 'Player' + Math.floor(Math.random() * 1000);

            // Mode selection
            modeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    modeBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedMode = btn.getAttribute('data-mode');
                });
            });

            // Play button
            playBtn.addEventListener('click', () => {
                const name = nameInput.value.trim();
                const color = colorInput.value;
                if (!name) {
                    alert('Please enter a player name!');
                    return;
                }
                
                // Store selections globally for game start
                window.IO_MENU_SELECTION = { name, color, mode: selectedMode };
                mainMenu.style.display = 'none';
                
                // Start the game with the selected options
                if (window.gameInstance) {
                    window.gameInstance.startWithMenuSelection();
                }
            });

            // Expose a function to show the menu again
            window.showMainMenu = function() {
                mainMenu.style.display = 'flex';
            };
        })();

        // Start the game when the page loads
        window.addEventListener('load', () => {
            window.gameInstance = new MultiplayerIOGame();
        });
    </script>
</body>
</html> 